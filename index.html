<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HACCP Dokumentations-Tool - Pflegeheim</title>
    <style>
        /* Styles from previous response remain here */
         * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            line-height: 1.6;
            color: #2c3e50;
            background: linear-gradient(135deg, #f8fbff 0%, #e8f4f8 100%);
            min-height: 100vh;
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
            padding: 30px;
            border-radius: 15px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 10px 30px rgba(231, 76, 60, 0.3);
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .header p {
            font-size: 1.2em;
            opacity: 0.9;
        }
        
        .nav-tabs {
            display: flex;
            background: white;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .nav-tab {
            flex: 1;
            padding: 15px;
            background: #ecf0f1;
            border: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s ease;
            color: #34495e;
        }
        
        .nav-tab.active {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .nav-tab:hover:not(.active) {
            background: #d5dbdb;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .card {
            background: white;
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 25px rgba(0,0,0,0.1);
            border-left: 5px solid #e74c3c;
        }
        
        .card h2 {
            color: #c0392b;
            margin-bottom: 20px;
            font-size: 1.8em;
            border-bottom: 3px solid #e74c3c;
            padding-bottom: 10px;
        }
        
        .temp-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }
        
        .temp-card {
            background: linear-gradient(135deg, #e8f8f5 0%, #d1f2eb 100%);
            padding: 20px;
            border-radius: 10px;
            border-left: 5px solid #27ae60;
        }
        
        .temp-card.critical {
            background: linear-gradient(135deg, #ffeaa7 0%, #fdcb6e 100%);
            border-left-color: #f39c12;
        }
        
        .temp-card.danger {
            background: linear-gradient(135deg, #fab1a0 0%, #e17055 100%);
            border-left-color: #e74c3c;
        }
        
        .temp-card h3 {
            color: #27ae60;
            margin-bottom: 15px;
            font-size: 1.4em;
        }
        
        .temp-card.critical h3 {
            color: #f39c12;
        }
        
        .temp-card.danger h3 {
            color: #e74c3c;
        }
        
        .temp-input-group {
            display: grid;
            grid-template-columns: 1fr 100px 80px;
            gap: 10px;
            margin-bottom: 15px;
            align-items: center;
        }
        
        .temp-input-group label {
            font-weight: bold;
            color: #2c3e50;
        }
        
        .temp-input-group input {
            padding: 8px;
            border: 2px solid #bdc3c7;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .temp-input-group input:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .temp-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-weight: bold;
            text-align: center;
            font-size: 12px;
        }
        
        .status-ok {
            background: #d4edda;
            color: #155724;
        }
        
        .status-warning {
            background: #fff3cd;
            color: #856404;
        }
        
        .status-critical {
            background: #f8d7da;
            color: #721c24;
        }
        
        .checklist {
            background: white;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .checklist h3 {
            color: #2c3e50;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .check-item {
            display: flex;
            align-items: center;
            padding: 10px;
            margin-bottom: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border-left: 4px solid #95a5a6;
        }
        
        .check-item.completed {
            background: #d4edda;
            border-left-color: #28a745;
        }
        
        .check-item.failed {
            background: #f8d7da;
            border-left-color: #dc3545;
        }
        
        .check-item input[type="checkbox"] {
            margin-right: 15px;
            transform: scale(1.2);
            flex-shrink: 0; /* Prevent checkbox from shrinking */
        }
        
        .check-item label {
            flex: 1;
            cursor: pointer;
            margin-right: 10px; /* Space between label and timestamp */
        }
        
        .check-item .timestamp {
            font-size: 0.9em;
            color: #6c757d;
            margin-right: 10px; /* Space between timestamp and responsible */
            white-space: nowrap; /* Prevent line break */
        }

        .check-item .responsible-display {
            font-size: 0.9em;
            color: #34495e;
            font-weight: bold;
            margin-right: 5px;
            white-space: nowrap;
        }

        .check-item .responsible-input {
            padding: 5px 8px;
            border: 1px solid #bdc3c7;
            border-radius: 5px;
            font-size: 0.9em;
            width: 80px; /* Fixed width for input */
            flex-shrink: 0;
        }
        
        .input-group {
            margin-bottom: 15px;
        }
        
        .input-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #34495e;
        }
        
        .input-group input, .input-group select, .input-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #bdc3c7;
            border-radius: 8px;
            font-size: 14px;
        }
        
        .input-group input:focus, .input-group select:focus, .input-group textarea:focus {
            outline: none;
            border-color: #e74c3c;
        }
        
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            margin: 10px 5px;
            transition: all 0.3s ease;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(231, 76, 60, 0.3);
        }
        
        .btn-success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #7f8c8d 0%, #95a5a6 100%);
            color: white;
        }
        
        .btn-success:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
        }

        .btn-secondary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(127, 140, 141, 0.3);
        }
        
        .summary-box {
            background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .summary-box h3 {
            margin-bottom: 15px;
        }
        
        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
        }
        
        .stat-item {
            background: rgba(255,255,255,0.2);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            display: block;
        }
        
        .corrective-action {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .corrective-action h4 {
            color: #856404;
            margin-bottom: 10px;
        }
        
        .protocol-table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        
        .protocol-table th {
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
            color: white;
            padding: 15px;
            text-align: left;
        }
        
        .protocol-table td {
            padding: 12px 15px;
            border-bottom: 1px solid #ecf0f1;
            vertical-align: top; /* Align cell content to top */
        }
        
        .protocol-table tr:nth-child(even) {
            background-color: #f8f9fa;
        }
        
        .protocol-table tr:hover {
            background-color: #e8f4f8;
        }
        
        .alert {
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            font-weight: bold;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .footer {
            text-align: center;
            margin-top: 30px;
            padding: 20px;
            background: #34495e;
            color: white;
            border-radius: 10px;
        }

        #textProtocolOutput {
            width: 100%;
            height: 300px;
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', Courier, monospace;
            font-size: 1em;
            white-space: pre; /* Preserve whitespace and line breaks */
            overflow: auto; /* Enable scrolling if content is too large */
            background-color: #fdfdfd;
        }
        
        @media (max-width: 768px) {
            .nav-tabs {
                flex-direction: column;
            }
            
            .temp-input-group {
                grid-template-columns: 1fr;
                gap: 5px;
            }
            
            .temp-grid {
                grid-template-columns: 1fr;
            }

            .check-item {
                flex-wrap: wrap; /* Allow items to wrap on smaller screens */
            }

            .check-item label {
                flex-basis: 100%; /* Make label take full width */
                margin-bottom: 5px;
            }

            .check-item .timestamp, .check-item .responsible-display, .check-item .responsible-input {
                margin-top: 5px;
                margin-left: 0;
                width: auto; /* Allow auto width for flexible content */
            }
        }
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important; 
                color-adjust: exact !important;
                margin: 20px; 
                font-size: 10pt; 
            }
            .header { 
                background: #e74c3c !important; /* Force background color */
                color: white !important; 
                padding: 15px; 
                border-radius: 8px; 
                text-align: center; 
                margin-bottom: 20px; 
                box-shadow: none; 
            }
            .card { 
                box-shadow: none; 
                border: 1px solid #ccc; 
                margin-bottom: 15px; 
                padding: 15px; 
                border-left: 5px solid #e74c3c; 
            }
            .protocol-table { 
                width: 100%; 
                border-collapse: collapse; 
                margin: 15px 0; 
            }
            .protocol-table th, .protocol-table td { 
                border: 1px solid #ddd; 
                padding: 8px; 
                text-align: left; 
            }
            .protocol-table th { 
                background: #34495e !important; /* Force background color */
                color: white !important; 
            }
            .summary-box { 
                background: #0984e3 !important; /* Force background color */
                color: white !important; 
                padding: 15px; 
                border-radius: 8px; 
                margin: 15px 0; 
            }
            .summary-stats { 
                display: flex; 
                flex-wrap: wrap; 
                justify-content: space-around; 
                gap: 10px; 
            }
            .stat-item { 
                background: rgba(255,255,255,0.2) !important; /* Force background color */
                padding: 10px; 
                border-radius: 5px; 
                flex: 1; 
                min-width: 120px; 
                text-align: center; 
            }
            /* Hide elements not relevant for printing */
            .nav-tabs, .btn, .footer, #textProtocolOutput { display: none !important; }
            /* Ensure text is readable */
            .protocol-table td { color: #000; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üõ°Ô∏è HACCP Dokumentations-Tool</h1>
            <p>Hazard Analysis Critical Control Points - K√ºchenhygiene Pflegeheim</p>
            <p><strong>Datum:</strong> <span id="currentDate"></span> | <strong>Schicht:</strong> <span id="currentShift"></span></p>
        </div>

        <div class="nav-tabs">
            <button class="nav-tab active" onclick="switchTab('temperatures')">üå°Ô∏è Temperaturen</button>
            <button class="nav-tab" onclick="switchTab('hygiene')">üßº Hygiene</button>
            <button class="nav-tab" onclick="switchTab('storage')">üì¶ Lagerung</button>
            <button class="nav-tab" onclick="switchTab('cleaning')">üßΩ Reinigung</button>
            <button class="nav-tab" onclick="switchTab('protocols')">üìã Protokolle</button>
        </div>

        <div id="temperatures" class="tab-content active">
             <div class="card">
                <h2>üå°Ô∏è Temperaturkontrolle</h2>
                <div class="temp-grid">
                    <div class="temp-card">
                        <h3>‚ùÑÔ∏è K√ºhlschrank 1 links</h3>
                        <p><strong>Sollwert:</strong> 2¬∞C bis 7¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="fridge1-temp" step="0.1" placeholder="z.B. 4.2" onchange="checkTemperature('fridge1', this.value, 2, 7)">
                            <div id="fridge1-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="fridge1-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card">
                        <h3>‚ùÑÔ∏è K√ºhlschrank 2 rechts</h3>
                        <p><strong>Sollwert:</strong> 2¬∞C bis 7¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="fridge2-temp" step="0.1" placeholder="z.B. 4.2" onchange="checkTemperature('fridge2', this.value, 2, 7)">
                            <div id="fridge2-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="fridge2-time">
                            <div></div>
                        </div>
                    </div>

                     <div class="temp-card">
                        <h3>‚ùÑÔ∏è K√ºhlschrank 3 Lager</h3>
                        <p><strong>Sollwert:</strong> 2¬∞C bis 7¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="fridge3-temp" step="0.1" placeholder="z.B. 4.2" onchange="checkTemperature('fridge3', this.value, 2, 7)">
                            <div id="fridge3-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="fridge3-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card">
                        <h3>üßä TK 1 links</h3>
                        <p><strong>Sollwert:</strong> -18¬∞C oder k√§lter</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="freezer1-temp" step="0.1" placeholder="z.B. -20.5" onchange="checkTemperature('freezer1', this.value, -30, -18)">
                            <div id="freezer1-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="freezer1-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card">
                        <h3>üßä TK 2 rechts</h3>
                        <p><strong>Sollwert:</strong> -18¬∞C oder k√§lter</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="freezer2-temp" step="0.1" placeholder="z.B. -20.5" onchange="checkTemperature('freezer2', this.value, -30, -18)">
                            <div id="freezer2-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="freezer2-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card critical">
                        <h3>üî• Warmhaltung</h3>
                        <p><strong>Sollwert:</strong> mindestens 65¬∞C</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="warmer-temp" step="0.1" placeholder="z.B. 68.0" onchange="checkTemperature('warmer', this.value, 65, 100)">
                            <div id="warmer-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="warmer-time">
                            <div></div>
                        </div>
                    </div>

                    <div class="temp-card critical">
                        <h3>üç≤ Speisen beim Servieren</h3>
                        <p><strong>Sollwert:</strong> mindestens 65¬∞C (warm) / max. 7¬∞C (kalt)</p>
                        <div class="temp-input-group">
                            <label>Gemessene Temperatur:</label>
                            <input type="number" id="serving-temp" step="0.1" placeholder="z.B. 67.5" onchange="checkServingTemperature(this.value)">
                            <div id="serving-status" class="temp-status">-</div>
                        </div>
                        <div class="temp-input-group">
                            <label>Art der Speise:</label>
                            <select id="serving-type" onchange="checkServingTemperature(document.getElementById('serving-temp').value)">
                                <option value="warm">Warme Speise</option>
                                <option value="cold">Kalte Speise</option>
                            </select>
                            <div></div>
                        </div>
                        <div class="input-group">
                            <label for="serving-notes">Bemerkungen (z.B. Speise):</label>
                            <input type="text" id="serving-notes" placeholder="z.B. Kartoffelbrei">
                        </div>
                        <div class="temp-input-group">
                            <label>Uhrzeit der Messung:</label>
                            <input type="time" id="serving-time">
                            <div></div>
                        </div>
                    </div>
                </div>

                <div class="corrective-action" id="temp-corrective" style="display: none;">
                    <h4>‚ö†Ô∏è Korrekturma√ünahmen erforderlich</h4>
                    <div class="input-group">
                        <label for="temp-action">Durchgef√ºhrte Ma√ünahmen:</label>
                        <textarea id="temp-action" rows="3" placeholder="z.B. K√ºhlung √ºberpr√ºft, Service informiert, Speisen nacherhitzt..."></textarea>
                    </div>
                    <div class="input-group">
                        <label for="temp-responsible">Verantwortlicher Mitarbeiter:</label>
                        <input type="text" id="temp-responsible" placeholder="Name des Mitarbeiters">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveTemperatures()">üíæ Temperaturen speichern</button>
            </div>
        </div>

        <div id="hygiene" class="tab-content">
            <div class="card">
                <h2>üßº Hygienecheckliste</h2>
                
                <div class="checklist">
                    <h3>üë• Personalhygiene</h3>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-hands" onchange="updateCheckItem(this)">
                        <label for="hygiene-hands">H√§ndewaschen und Desinfektion vor Arbeitsbeginn</label>
                        <span class="timestamp" id="hygiene-hands-time"></span>
                        <span class="responsible-display" id="hygiene-hands-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-hands-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-clothing" onchange="updateCheckItem(this)">
                        <label for="hygiene-clothing">Saubere Arbeitskleidung und Kopfbedeckung</label>
                        <span class="timestamp" id="hygiene-clothing-time"></span>
                        <span class="responsible-display" id="hygiene-clothing-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-clothing-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-wounds" onchange="updateCheckItem(this)">
                        <label for="hygiene-wounds">Wunden und Verletzungen ordnungsgem√§√ü abgedeckt</label>
                        <span class="timestamp" id="hygiene-wounds-time"></span>
                        <span class="responsible-display" id="hygiene-wounds-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-wounds-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="hygiene-jewelry" onchange="updateCheckItem(this)">
                        <label for="hygiene-jewelry">Schmuck abgelegt (au√üer Ehering)</label>
                        <span class="timestamp" id="hygiene-jewelry-time"></span>
                        <span class="responsible-display" id="hygiene-jewelry-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="hygiene-jewelry-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üçΩÔ∏è Lebensmittelhygiene</h3>
                    <div class="check-item">
                        <input type="checkbox" id="food-separation" onchange="updateCheckItem(this)">
                        <label for="food-separation">Rohe und gegarte Lebensmittel getrennt verarbeitet</label>
                        <span class="timestamp" id="food-separation-time"></span>
                        <span class="responsible-display" id="food-separation-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-separation-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-boards" onchange="updateCheckItem(this)">
                        <label for="food-boards">Verschiedene Schneidebretter f√ºr verschiedene Lebensmittel</label>
                        <span class="timestamp" id="food-boards-time"></span>
                        <span class="responsible-display" id="food-boards-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-boards-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-storage" onchange="updateCheckItem(this)">
                        <label for="food-storage">Lebensmittel ordnungsgem√§√ü gelagert und abgedeckt</label>
                        <span class="timestamp" id="food-storage-time"></span>
                        <span class="responsible-display" id="food-storage-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-storage-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="food-dates" onchange="updateCheckItem(this)">
                        <label for="food-dates">Verfallsdaten √ºberpr√ºft und dokumentiert</label>
                        <span class="timestamp" id="food-dates-time"></span>
                        <span class="responsible-display" id="food-dates-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="food-dates-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üßΩ Arbeitspl√§tze und Ger√§te</h3>
                    <div class="check-item">
                        <input type="checkbox" id="work-surfaces" onchange="updateCheckItem(this)">
                        <label for="work-surfaces">Arbeitsfl√§chen gereinigt und desinfiziert</label>
                        <span class="timestamp" id="work-surfaces-time"></span>
                        <span class="responsible-display" id="work-surfaces-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="work-surfaces-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="equipment-clean" onchange="updateCheckItem(this)">
                        <label for="equipment-clean">Ger√§te und Maschinen nach Gebrauch gereinigt</label>
                        <span class="timestamp" id="equipment-clean-time"></span>
                        <span class="responsible-display" id="equipment-clean-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="equipment-clean-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="utensils-clean" onchange="updateCheckItem(this)">
                        <label for="utensils-clean">K√ºchenutensilien sauber und intakt</label>
                        <span class="timestamp" id="utensils-clean-time"></span>
                        <span class="responsible-display" id="utensils-clean-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="utensils-clean-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <button class="btn btn-primary" onclick="saveHygieneChecklist()">üíæ Checkliste speichern</button>
            </div>
        </div>

        <div id="storage" class="tab-content">
            <div class="card">
                <h2>üì¶ Lagerungskontrolle</h2>
                <div class="input-group">
                    <label for="storage-food">Gelagerte Lebensmittel / Produkte:</label>
                    <input type="text" id="storage-food" placeholder="z.B. Milchprodukte, Fleisch, Gem√ºse">
                </div>
                <div class="input-group">
                    <label for="storage-condition">Lagerbedingungen:</label>
                    <select id="storage-condition">
                        <option value="ok">Einwandfrei (k√ºhl, trocken, sauber)</option>
                        <option value="warning">Verbesserungsw√ºrdig (z.B. unordentlich)</option>
                        <option value="critical">Kritisch (z.B. √úberschreitung von Temperatur, offene Verpackung)</option>
                    </select>
                </div>
                <div class="input-group">
                    <label for="storage-comments">Bemerkungen zur Lagerung:</label>
                    <textarea id="storage-comments" rows="3" placeholder="Besondere Vorkommnisse oder Beobachtungen"></textarea>
                </div>
                <div class="input-group">
                    <label for="storage-responsible">Verantwortlicher Mitarbeiter:</label>
                    <input type="text" id="storage-responsible" placeholder="Name oder K√ºrzel">
                </div>
                <button class="btn btn-primary" onclick="saveStorageCheck()">üíæ Lagerung speichern</button>
            </div>
        </div>

        <div id="cleaning" class="tab-content">
            <div class="card">
                <h2>üßΩ Reinigungsplan</h2>

                <div class="checklist">
                    <h3>üóìÔ∏è T√§gliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="daily-surfaces" onchange="updateCheckItem(this)">
                        <label for="daily-surfaces">Alle Arbeitsfl√§chen und Sp√ºlbecken</label>
                        <span class="timestamp" id="daily-surfaces-time"></span>
                        <span class="responsible-display" id="daily-surfaces-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-surfaces-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="daily-floor" onchange="updateCheckItem(this)">
                        <label for="daily-floor">Boden reinigen und desinfizieren</label>
                        <span class="timestamp" id="daily-floor-time"></span>
                        <span class="responsible-display" id="daily-floor-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-floor-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="daily-equipment" onchange="updateCheckItem(this)">
                        <label for="daily-equipment">Kleine K√ºchenger√§te (Mixer, etc.)</label>
                        <span class="timestamp" id="daily-equipment-time"></span>
                        <span class="responsible-display" id="daily-equipment-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-equipment-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="daily-bin" onchange="updateCheckItem(this)">
                        <label for="daily-bin">M√ºlleimer leeren und reinigen</label>
                        <span class="timestamp" id="daily-bin-time"></span>
                        <span class="responsible-display" id="daily-bin-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-bin-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="daily-sinks" onchange="updateCheckItem(this)">
                        <label for="daily-sinks">Sp√ºlbecken und Armaturen</label>
                        <span class="timestamp" id="daily-sinks-time"></span>
                        <span class="responsible-display" id="daily-sinks-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-sinks-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="daily-cupboarddoors" onchange="updateCheckItem(this)">
                        <label for="daily-cupboarddoors">Schrankt√ºren</label>
                        <span class="timestamp" id="daily-cupboarddoors-time"></span>
                        <span class="responsible-display" id="daily-cupboarddoors-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-cupboarddoors-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="daily-stove" onchange="updateCheckItem(this)">
                        <label for="daily-stove">Herd</label>
                        <span class="timestamp" id="daily-stove-time"></span>
                        <span class="responsible-display" id="daily-stove-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-stove-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="daily-microwave" onchange="updateCheckItem(this)">
                        <label for="daily-microwave">Mikrowelle</label>
                        <span class="timestamp" id="daily-microwave-time"></span>
                        <span class="responsible-display" id="daily-microwave-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="daily-microwave-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üóìÔ∏è W√∂chentliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="weekly-fridge" onchange="updateCheckItem(this)">
                        <label for="weekly-fridge">K√ºhlschr√§nke innen reinigen</label>
                        <span class="timestamp" id="weekly-fridge-time"></span>
                        <span class="responsible-display" id="weekly-fridge-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-fridge-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="weekly-freezer" onchange="updateCheckItem(this)">
                        <label for="weekly-freezer">Tiefk√ºhlschr√§nke abtauen und reinigen</label>
                        <span class="timestamp" id="weekly-freezer-time"></span>
                        <span class="responsible-display" id="weekly-freezer-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-freezer-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="weekly-oven" onchange="updateCheckItem(this)">
                        <label for="weekly-oven">Backofen und Dunstabzugshaube reinigen</label>
                        <span class="timestamp" id="weekly-oven-time"></span>
                        <span class="responsible-display" id="weekly-oven-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-oven-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="weekly-storage" onchange="updateCheckItem(this)">
                        <label for="weekly-storage">Vorratsr√§ume/Lagerbereiche reinigen</label>
                        <span class="timestamp" id="weekly-storage-time"></span>
                        <span class="responsible-display" id="weekly-storage-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-storage-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="weekly-tiles" onchange="updateCheckItem(this)">
                        <label for="weekly-tiles">Fliesen und W√§nde abwischen</label>
                        <span class="timestamp" id="weekly-tiles-time"></span>
                        <span class="responsible-display" id="weekly-tiles-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-tiles-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="weekly-convectomat" onchange="updateCheckItem(this)">
                        <label for="weekly-convectomat">Convektomat reinigen</label>
                        <span class="timestamp" id="weekly-convectomat-time"></span>
                        <span class="responsible-display" id="weekly-convectomat-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-convectomat-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="weekly-coffeemachine" onchange="updateCheckItem(this)">
                        <label for="weekly-coffeemachine">Kaffeemaschine entkalken</label>
                        <span class="timestamp" id="weekly-coffeemachine-time"></span>
                        <span class="responsible-display" id="weekly-coffeemachine-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-coffeemachine-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="weekly-drawers-microwave" onchange="updateCheckItem(this)">
                        <label for="weekly-drawers-microwave">Schubladen 1-3 bei der Mikrowelle reinigen</label>
                        <span class="timestamp" id="weekly-drawers-microwave-time"></span>
                        <span class="responsible-display" id="weekly-drawers-microwave-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-drawers-microwave-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="weekly-drawers-left" onchange="updateCheckItem(this)">
                        <label for="weekly-drawers-left">Schubladen 1-3 links reinigen</label>
                        <span class="timestamp" id="weekly-drawers-left-time"></span>
                        <span class="responsible-display" id="weekly-drawers-left-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-drawers-left-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                     <div class="check-item">
                        <input type="checkbox" id="weekly-drawers-right" onchange="updateCheckItem(this)">
                        <label for="weekly-drawers-right">Schubladen 1-2 rechts reinigen</label>
                        <span class="timestamp" id="weekly-drawers-right-time"></span>
                        <span class="responsible-display" id="weekly-drawers-right-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="weekly-drawers-right-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üóìÔ∏è Monatliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="monthly-fridge-deep" onchange="updateCheckItem(this)">
                        <label for="monthly-fridge-deep">K√ºhlschr√§nke gr√ºndlich reinigen und desinfizieren</label>
                        <span class="timestamp" id="monthly-fridge-deep-time"></span>
                        <span class="responsible-display" id="monthly-fridge-deep-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="monthly-fridge-deep-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="monthly-ventilator" onchange="updateCheckItem(this)">
                        <label for="monthly-ventilator">Abluftventilatoren reinigen</label>
                        <span class="timestamp" id="monthly-ventilator-time"></span>
                        <span class="responsible-display" id="monthly-ventilator-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="monthly-ventilator-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>

                <div class="checklist">
                    <h3>üóìÔ∏è Viertelj√§hrliche Reinigung</h3>
                    <div class="check-item">
                        <input type="checkbox" id="quarterly-freezer-deep" onchange="updateCheckItem(this)">
                        <label for="quarterly-freezer-deep">Tiefk√ºhlschr√§nke komplett abtauen, reinigen und desinfizieren</label>
                        <span class="timestamp" id="quarterly-freezer-deep-time"></span>
                        <span class="responsible-display" id="quarterly-freezer-deep-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="quarterly-freezer-deep-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                    <div class="check-item">
                        <input type="checkbox" id="quarterly-grease-trap" onchange="updateCheckItem(this)">
                        <label for="quarterly-grease-trap">Fettabscheider kontrollieren (wenn zutreffend)</label>
                        <span class="timestamp" id="quarterly-grease-trap-time"></span>
                        <span class="responsible-display" id="quarterly-grease-trap-responsible-display" style="display: none;">Verantwortlich: <span class="responsible-name"></span></span>
                        <input type="text" class="responsible-input" id="quarterly-grease-trap-responsible-input" placeholder="K√ºrzel" style="display: none;">
                    </div>
                </div>
                
                <button class="btn btn-primary" onclick="saveCleaningChecklist()">üíæ Reinigungsplan speichern</button>
            </div>
        </div>

        <div id="protocols" class="tab-content">
            <div class="card">
                <h2>üìã Gespeicherte Protokolle</h2>
                <div class="summary-box">
                    <h3>Protokoll-√úbersicht</h3>
                    <div class="summary-stats">
                        <div class="stat-item">
                            <span class="stat-number" id="total-protocols">0</span>
                            <span>Gesamtprotokolle</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="protocols-this-month">0</span>
                            <span>Diesen Monat</span>
                        </div>
                        <div class="stat-item">
                            <span class="stat-number" id="protocols-failed">0</span>
                            <span>Auff√§lligkeiten</span>
                        </div>
                    </div>
                </div>
                <button class="btn btn-success" onclick="printDailyProtocol()">üñ®Ô∏è Tagesprotokoll drucken</button>
                <button class="btn btn-secondary" onclick="generateTextProtocol()">üìÑ Textprotokoll generieren</button>
                <button class="btn btn-primary" onclick="clearAllProtocols()">üóëÔ∏è Alle Protokolle l√∂schen</button>

                <div class="input-group" style="margin-top: 20px;">
                    <label for="filterDate">Protokolle filtern nach Datum:</label>
                    <input type="date" id="filterDate" onchange="filterProtocols()">
                </div>

                <table class="protocol-table">
                    <thead>
                        <tr>
                            <th>Datum</th>
                            <th>Schicht</th>
                            <th>Bereich</th>
                            <th>Details</th>
                            <th>Status / Wert</th>
                            <th>Verantwortlicher / K√ºrzel</th>
                            <th>Ma√ünahmen (falls n√∂tig)</th>
                        </tr>
                    </thead>
                    <tbody id="protocolTableBody">
                        </tbody>
                </table>

                <h3 style="margin-top: 30px;">Textversion des Protokolls</h3>
                <textarea id="textProtocolOutput" readonly placeholder="Klicken Sie auf 'Textprotokoll generieren', um die Textversion des aktuellen Tagesprotokolls hier anzuzeigen."></textarea>
            </div>
        </div>

        <div class="footer">
            <p>¬© 2025 HACCP Dokumentations-Tool - Pflegeheim</p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            updateCurrentDateAndShift();
            loadTemperatures();
            loadHygieneChecklist();
            loadStorageCheck();
            loadCleaningChecklist();
            loadProtocols();
            setupResponsibleInputs();
        });

        // Helper function to format date and time
        function getFormattedDateTime() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: '2-digit', day: '2-digit' };
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            return {
                date: now.toLocaleDateString('de-DE', dateOptions),
                time: now.toLocaleTimeString('de-DE', timeOptions),
                full: now.toISOString()
            };
        }

        function updateCurrentDateAndShift() {
            const now = new Date();
            document.getElementById('currentDate').textContent = now.toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            const hour = now.getHours();
            let shift = 'Tagesschicht';
            if (hour >= 22 || hour < 6) {
                shift = 'Nachtschicht';
            } else if (hour >= 14 && hour < 22) {
                shift = 'Sp√§tschicht';
            } else {
                shift = 'Fr√ºhschicht';
            }
            document.getElementById('currentShift').textContent = shift;
        }

        function switchTab(tabId) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.nav-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            document.getElementById(tabId).classList.add('active');
            document.querySelector(`.nav-tab[onclick="switchTab('${tabId}')"]`).classList.add('active');
            
            // Reload protocols if switching to protocols tab
            if (tabId === 'protocols') {
                loadProtocols();
            }
        }

        // --- Temperature Logic ---
        function checkTemperature(id, value, min, max) {
            const statusElement = document.getElementById(`${id}-status`);
            const tempCard = statusElement.closest('.temp-card');
            const temp = parseFloat(value);
            const correctiveActionDiv = document.getElementById('temp-corrective');

            statusElement.className = 'temp-status'; // Reset classes
            tempCard.classList.remove('critical', 'danger'); // Reset card classes

            if (isNaN(temp)) {
                statusElement.textContent = '-';
                correctiveActionDiv.style.display = 'none';
                return;
            }

            if (temp < min || temp > max) {
                statusElement.textContent = `‚ö†Ô∏è ${temp}¬∞C`;
                statusElement.classList.add('status-critical');
                tempCard.classList.add('danger');
                correctiveActionDiv.style.display = 'block';
            } else if (temp >= min && temp <= max) {
                statusElement.textContent = `‚úÖ ${temp}¬∞C`;
                statusElement.classList.add('status-ok');
                correctiveActionDiv.style.display = 'none';
            }
        }

        function checkServingTemperature(value) {
            const statusElement = document.getElementById('serving-status');
            const tempCard = statusElement.closest('.temp-card');
            const temp = parseFloat(value);
            const type = document.getElementById('serving-type').value;
            const correctiveActionDiv = document.getElementById('temp-corrective');

            statusElement.className = 'temp-status'; // Reset classes
            tempCard.classList.remove('critical', 'danger'); // Reset card classes

            if (isNaN(temp)) {
                statusElement.textContent = '-';
                correctiveActionDiv.style.display = 'none';
                return;
            }

            if (type === 'warm') {
                if (temp < 65) {
                    statusElement.textContent = `‚ö†Ô∏è ${temp}¬∞C`;
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                    correctiveActionDiv.style.display = 'block';
                } else {
                    statusElement.textContent = `‚úÖ ${temp}¬∞C`;
                    statusElement.classList.add('status-ok');
                    correctiveActionDiv.style.display = 'none';
                }
            } else if (type === 'cold') {
                if (temp > 7) {
                    statusElement.textContent = `‚ö†Ô∏è ${temp}¬∞C`;
                    statusElement.classList.add('status-critical');
                    tempCard.classList.add('danger');
                    correctiveActionDiv.style.display = 'block';
                } else {
                    statusElement.textContent = `‚úÖ ${temp}¬∞C`;
                    statusElement.classList.add('status-ok');
                    correctiveActionDiv.style.display = 'none';
                }
            }
        }

        function saveTemperatures() {
            const dateTime = getFormattedDateTime();
            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');

            const tempReadings = [
                { id: 'fridge1', name: 'K√ºhlschrank 1 links', min: 2, max: 7 },
                { id: 'fridge2', name: 'K√ºhlschrank 2 rechts', min: 2, max: 7 },
                { id: 'fridge3', name: 'K√ºhlschrank 3 Lager', min: 2, max: 7 },
                { id: 'freezer1', name: 'TK 1 links', min: -30, max: -18 },
                { id: 'freezer2', name: 'TK 2 rechts', min: -30, max: -18 },
                { id: 'warmer', name: 'Warmhaltung', min: 65, max: 100 }
            ];

            tempReadings.forEach(item => {
                const temp = parseFloat(document.getElementById(`${item.id}-temp`).value);
                const time = document.getElementById(`${item.id}-time`).value;
                const statusElement = document.getElementById(`${item.id}-status`);
                let status = statusElement.textContent.includes('‚úÖ') ? 'OK' : (statusElement.textContent.includes('‚ö†Ô∏è') ? 'KRITISCH' : 'N/A');
                let action = '';
                let responsible = '';

                if (status === 'KRITISCH') {
                    action = document.getElementById('temp-action').value;
                    responsible = document.getElementById('temp-responsible').value;
                }

                if (!isNaN(temp) && time) {
                     protocols.push({
                        date: dateTime.date,
                        shift: document.getElementById('currentShift').textContent,
                        area: 'Temperatur',
                        detail: item.name,
                        value: `${temp}¬∞C`,
                        status: status,
                        time: time,
                        responsible: responsible,
                        action: action
                    });
                }
            });

            // Handle serving temperature separately due to dual criteria
            const servingTemp = parseFloat(document.getElementById('serving-temp').value);
            const servingTime = document.getElementById('serving-time').value;
            const servingType = document.getElementById('serving-type').value;
            const servingNotes = document.getElementById('serving-notes').value;
            const servingStatusElement = document.getElementById('serving-status');
            let servingStatus = servingStatusElement.textContent.includes('‚úÖ') ? 'OK' : (servingStatusElement.textContent.includes('‚ö†Ô∏è') ? 'KRITISCH' : 'N/A');
            let servingAction = '';
            let servingResponsible = '';

            if (servingStatus === 'KRITISCH') {
                servingAction = document.getElementById('temp-action').value;
                servingResponsible = document.getElementById('temp-responsible').value;
            }

            if (!isNaN(servingTemp) && servingTime) {
                protocols.push({
                    date: dateTime.date,
                    shift: document.getElementById('currentShift').textContent,
                    area: 'Temperatur',
                    detail: `Speisen beim Servieren (${servingType}): ${servingNotes || 'N/A'}`,
                    value: `${servingTemp}¬∞C`,
                    status: servingStatus,
                    time: servingTime,
                    responsible: servingResponsible,
                    action: servingAction
                });
            }

            localStorage.setItem('haccpProtocols', JSON.stringify(protocols));
            alert('Temperaturen erfolgreich gespeichert!');
            resetTemperaturesForm();
            loadProtocols(); // Reload protocols table
        }

        function resetTemperaturesForm() {
            document.querySelectorAll('#temperatures input[type="number"]').forEach(input => input.value = '');
            document.querySelectorAll('#temperatures input[type="time"]').forEach(input => input.value = '');
            document.querySelectorAll('.temp-status').forEach(status => {
                status.textContent = '-';
                status.className = 'temp-status';
            });
            document.querySelectorAll('.temp-card').forEach(card => card.classList.remove('critical', 'danger'));
            document.getElementById('temp-corrective').style.display = 'none';
            document.getElementById('temp-action').value = '';
            document.getElementById('temp-responsible').value = '';
            document.getElementById('serving-notes').value = '';
        }

        function loadTemperatures() {
            // No direct loading back to form as form is meant for new daily entries.
            // Data is primarily shown in the protocols tab.
        }

        // --- Hygiene/Cleaning/Storage Checkitem Logic ---
        function setupResponsibleInputs() {
            document.querySelectorAll('.check-item input[type="checkbox"]').forEach(checkbox => {
                const id = checkbox.id;
                const responsibleDisplay = document.getElementById(`${id}-responsible-display`);
                const responsibleInput = document.getElementById(`${id}-responsible-input`);

                // Initial state based on checkbox checked status
                if (checkbox.checked) {
                    responsibleDisplay.style.display = 'inline';
                    responsibleInput.style.display = 'none';
                } else {
                    responsibleDisplay.style.display = 'none';
                    responsibleInput.style.display = 'inline';
                }

                // Event listener for input field to show display span when filled
                responsibleInput.addEventListener('input', function() {
                    if (this.value.trim() !== '') {
                        responsibleDisplay.querySelector('.responsible-name').textContent = this.value.trim();
                        responsibleDisplay.style.display = 'inline';
                        this.style.display = 'none';
                    } else {
                        responsibleDisplay.style.display = 'none';
                        this.style.display = 'inline';
                    }
                });
            });
        }

        function updateCheckItem(checkbox) {
            const item = checkbox.closest('.check-item');
            const timestampSpan = item.querySelector('.timestamp');
            const responsibleDisplay = item.querySelector('.responsible-display');
            const responsibleInput = item.querySelector('.responsible-input');

            if (checkbox.checked) {
                const { time } = getFormattedDateTime();
                timestampSpan.textContent = `Erledigt: ${time} Uhr`;
                item.classList.add('completed');
                item.classList.remove('failed'); // Remove failed if it was set
                responsibleInput.style.display = 'inline'; // Always show input when checked for K√ºrzel
            } else {
                timestampSpan.textContent = '';
                item.classList.remove('completed');
                item.classList.remove('failed'); // Remove failed if it was set
                responsibleInput.style.display = 'inline'; // Always show input when unchecked for K√ºrzel
                responsibleInput.value = ''; // Clear responsible input if unchecked
                responsibleDisplay.style.display = 'none'; // Hide responsible display
            }
        }


        function saveChecklist(checklistType) {
            const dateTime = getFormattedDateTime();
            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');
            const checklistContainer = document.getElementById(checklistType);
            const checkboxes = checklistContainer.querySelectorAll('.check-item input[type="checkbox"]');
            let hasUnchecked = false;

            checkboxes.forEach(checkbox => {
                const id = checkbox.id;
                const label = checklistContainer.querySelector(`label[for="${id}"]`).textContent;
                const responsibleInput = document.getElementById(`${id}-responsible-input`);
                const responsible = responsibleInput.value.trim();
                const status = checkbox.checked ? 'Erledigt' : 'Ausstehend';
                const timestamp = checkbox.checked ? document.getElementById(`${id}-time`).textContent.replace('Erledigt: ', '').replace(' Uhr', '') : ''; // Extract only time

                if (!checkbox.checked) {
                    hasUnchecked = true;
                }
                
                // Only save checked items or items that were explicitly marked as failed
                // For "Ausstehend" status, we still want to log it if the form is submitted
                protocols.push({
                    date: dateTime.date,
                    shift: document.getElementById('currentShift').textContent,
                    area: checklistType === 'hygiene' ? 'Hygiene' : (checklistType === 'cleaning' ? 'Reinigung' : 'Lagerung'),
                    detail: label,
                    value: status,
                    status: status, // Use status for the status column
                    time: timestamp,
                    responsible: responsible,
                    action: checkbox.checked ? '' : 'Ma√ünahme erforderlich (siehe n√§chste Schicht/Verantwortlicher)' // Action if not done
                });
            });

            localStorage.setItem('haccpProtocols', JSON.stringify(protocols));
            alert(`${checklistType.charAt(0).toUpperCase() + checklistType.slice(1)}-Checkliste erfolgreich gespeichert!`);
            resetChecklist(checklistType);
            loadProtocols();
        }

        function resetChecklist(checklistType) {
             const checklistContainer = document.getElementById(checklistType);
             checklistContainer.querySelectorAll('.check-item input[type="checkbox"]').forEach(checkbox => {
                 checkbox.checked = false;
                 checkbox.closest('.check-item').classList.remove('completed', 'failed');
                 checkbox.closest('.check-item').querySelector('.timestamp').textContent = '';
                 // Reset responsible input
                 const responsibleInput = checkbox.closest('.check-item').querySelector('.responsible-input');
                 responsibleInput.value = '';
                 responsibleInput.style.display = 'inline'; // Show input again
                 checkbox.closest('.check-item').querySelector('.responsible-display').style.display = 'none'; // Hide display
             });
        }
        
        function saveHygieneChecklist() {
            saveChecklist('hygiene');
        }

        function saveCleaningChecklist() {
            saveChecklist('cleaning');
        }

        function saveStorageCheck() {
            const dateTime = getFormattedDateTime();
            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');

            const food = document.getElementById('storage-food').value;
            const condition = document.getElementById('storage-condition').value;
            const comments = document.getElementById('storage-comments').value;
            const responsible = document.getElementById('storage-responsible').value;
            
            let statusText = '';
            let actionText = '';
            let protocolStatus = 'OK';

            if (condition === 'ok') {
                statusText = 'Einwandfrei';
            } else if (condition === 'warning') {
                statusText = 'Verbesserungsw√ºrdig';
                actionText = '√úberpr√ºfung und Korrekturma√ünahmen erforderlich';
                protocolStatus = 'AUFF√ÑLLIG';
            } else if (condition === 'critical') {
                statusText = 'Kritisch';
                actionText = 'Sofortige Korrekturma√ünahmen und Meldung erforderlich';
                protocolStatus = 'KRITISCH';
            }

            protocols.push({
                date: dateTime.date,
                shift: document.getElementById('currentShift').textContent,
                area: 'Lagerung',
                detail: `Gelagerte Lebensmittel: ${food || 'N/A'}`,
                value: statusText,
                status: protocolStatus,
                time: dateTime.time,
                responsible: responsible,
                action: actionText + (comments ? ` (Bemerkung: ${comments})` : '')
            });

            localStorage.setItem('haccpProtocols', JSON.stringify(protocols));
            alert('Lagerungskontrolle erfolgreich gespeichert!');
            resetStorageCheck();
            loadProtocols();
        }

        function resetStorageCheck() {
            document.getElementById('storage-food').value = '';
            document.getElementById('storage-condition').value = 'ok';
            document.getElementById('storage-comments').value = '';
            document.getElementById('storage-responsible').value = '';
        }

        function loadHygieneChecklist() {
            // Similar to temperatures, form is for new entries, data goes to protocols
        }

        function loadStorageCheck() {
            // Similar to temperatures, form is for new entries, data goes to protocols
        }

        function loadCleaningChecklist() {
            // Similar to temperatures, form is for new entries, data goes to protocols
        }

        // --- Protocols Tab Logic ---
        function loadProtocols() {
            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');
            const tableBody = document.getElementById('protocolTableBody');
            tableBody.innerHTML = ''; // Clear existing rows

            // Filter protocols if a date is selected
            const filterDateInput = document.getElementById('filterDate').value;
            const filteredProtocols = filterDateInput 
                ? protocols.filter(p => p.date === new Date(filterDateInput).toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' }))
                : protocols;

            // Sort by date (newest first) and then by time
            filteredProtocols.sort((a, b) => {
                const dateA = new Date(a.date.split('.').reverse().join('-')); // Convert DD.MM.YYYY to YYYY-MM-DD
                const dateB = new Date(b.date.split('.').reverse().join('-'));
                
                if (dateA > dateB) return -1;
                if (dateA < dateB) return 1;

                // If dates are the same, sort by time
                const timeA = a.time || '00:00'; // Default if time is missing
                const timeB = b.time || '00:00';
                return timeB.localeCompare(timeA); // Sort time in descending order (latest first)
            });

            let totalProtocols = 0;
            let protocolsThisMonth = 0;
            let protocolsFailed = 0;
            const currentMonth = new Date().getMonth();
            const currentYear = new Date().getFullYear();

            filteredProtocols.forEach(protocol => {
                totalProtocols++;

                const protocolDate = new Date(protocol.date.split('.').reverse().join('-'));
                if (protocolDate.getMonth() === currentMonth && protocolDate.getFullYear() === currentYear) {
                    protocolsThisMonth++;
                }

                if (protocol.status === 'KRITISCH' || protocol.status === 'AUFF√ÑLLIG' || protocol.value === 'Ausstehend') {
                    protocolsFailed++;
                }

                const row = tableBody.insertRow();
                row.insertCell().textContent = protocol.date || 'N/A';
                row.insertCell().textContent = protocol.shift || 'N/A';
                row.insertCell().textContent = protocol.area || 'N/A';
                row.insertCell().textContent = protocol.detail || 'N/A';
                row.insertCell().textContent = protocol.value || protocol.status || 'N/A';
                row.insertCell().textContent = protocol.responsible || 'N/A';
                row.insertCell().textContent = protocol.action || 'Keine';
            });

            document.getElementById('total-protocols').textContent = totalProtocols;
            document.getElementById('protocols-this-month').textContent = protocolsThisMonth;
            document.getElementById('protocols-failed').textContent = protocolsFailed;
        }

        function filterProtocols() {
            loadProtocols(); // Simply reload with the filter in place
        }

        function clearAllProtocols() {
            if (confirm('M√∂chtest du WIRKLICH alle gespeicherten Protokolle l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.')) {
                localStorage.removeItem('haccpProtocols');
                loadProtocols(); // Update table and summary
                alert('Alle Protokolle wurden gel√∂scht!');
                document.getElementById('textProtocolOutput').value = ''; // Clear text output too
            }
        }

        function printDailyProtocol() {
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Tagesprotokoll HACCP</title>');
            printWindow.document.write('<style>');
            printWindow.document.write(`
                body { font-family: 'Arial', sans-serif; margin: 20px; color: #333; }
                h1, h2 { color: #e74c3c; border-bottom: 2px solid #e74c3c; padding-bottom: 5px; margin-top: 20px; }
                h1 { font-size: 24px; text-align: center; }
                h2 { font-size: 18px; }
                p { margin-bottom: 5px; }
                table { width: 100%; border-collapse: collapse; margin-top: 15px; }
                th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
                th { background-color: #f2f2f2; color: #333; }
                .section { margin-bottom: 20px; page-break-inside: avoid; }
                .status-ok { color: green; font-weight: bold; }
                .status-critical, .status-warning { color: red; font-weight: bold; }
                .check-item.completed { background-color: #e6ffe6; }
                .check-item.failed { background-color: #ffe6e6; }
                .check-item { padding: 5px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; }
                .check-item span { font-size: 0.9em; color: #666; }
            `);
            printWindow.document.write('</style></head><body>');

            const currentDate = document.getElementById('currentDate').textContent;
            const currentShift = document.getElementById('currentShift').textContent;

            printWindow.document.write(`<h1>HACCP Tagesprotokoll</h1>`);
            printWindow.document.write(`<p><strong>Datum:</strong> ${currentDate}</p>`);
            printWindow.document.write(`<p><strong>Schicht:</strong> ${currentShift}</p>`);
            printWindow.document.write('<hr>');

            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');
            const today = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const todayProtocols = protocols.filter(p => p.date === today && p.shift === currentShift); // Filter for today and current shift

            // Group protocols by area
            const groupedProtocols = todayProtocols.reduce((acc, protocol) => {
                if (!acc[protocol.area]) {
                    acc[protocol.area] = [];
                }
                acc[protocol.area].push(protocol);
                return acc;
            }, {});

            for (const area in groupedProtocols) {
                printWindow.document.write(`<div class="section">`);
                printWindow.document.write(`<h2>${area}</h2>`);
                printWindow.document.write('<table>');
                printWindow.document.write('<thead><tr><th>Uhrzeit</th><th>Detail</th><th>Wert / Status</th><th>Verantwortlicher / K√ºrzel</th><th>Ma√ünahme</th></tr></thead>');
                printWindow.document.write('<tbody>');
                groupedProtocols[area].forEach(p => {
                    const statusClass = p.status === 'OK' ? 'status-ok' : (p.status === 'KRITISCH' || p.value === 'Ausstehend' || p.status === 'AUFF√ÑLLIG' ? 'status-critical' : '');
                    printWindow.document.write(`
                        <tr>
                            <td>${p.time || 'N/A'}</td>
                            <td>${p.detail || 'N/A'}</td>
                            <td class="${statusClass}">${p.value || p.status || 'N/A'}</td>
                            <td>${p.responsible || 'N/A'}</td>
                            <td>${p.action || 'Keine'}</td>
                        </tr>
                    `);
                });
                printWindow.document.write('</tbody></table>');
                printWindow.document.write(`</div>`);
            }
            
            if (todayProtocols.length === 0) {
                 printWindow.document.write('<p>F√ºr diese Schicht sind heute keine Protokolle vorhanden.</p>');
            }

            printWindow.document.write('</body></html>');
            printWindow.document.close();
            printWindow.print();
        }

        function generateTextProtocol() {
            const currentDate = document.getElementById('currentDate').textContent;
            const currentShift = document.getElementById('currentShift').textContent;
            const protocols = JSON.parse(localStorage.getItem('haccpProtocols') || '[]');
            const today = new Date().toLocaleDateString('de-DE', { year: 'numeric', month: '2-digit', day: '2-digit' });
            const todayProtocols = protocols.filter(p => p.date === today && p.shift === currentShift);

            let textOutput = `HACCP Tagesprotokoll\n`;
            textOutput += `Datum: ${currentDate}\n`;
            textOutput += `Schicht: ${currentShift}\n`;
            textOutput += `====================================================\n\n`;

            if (todayProtocols.length === 0) {
                textOutput += "F√ºr diese Schicht sind heute keine Protokolle vorhanden.\n";
            } else {
                const groupedProtocols = todayProtocols.reduce((acc, protocol) => {
                    if (!acc[protocol.area]) {
                        acc[protocol.area] = [];
                    }
                    acc[protocol.area].push(protocol);
                    return acc;
                }, {});

                for (const area in groupedProtocols) {
                    textOutput += `--- ${area} ---\n`;
                    groupedProtocols[area].forEach(p => {
                        textOutput += `  Uhrzeit: ${p.time || 'N/A'}\n`;
                        textOutput += `  Detail: ${p.detail || 'N/A'}\n`;
                        textOutput += `  Status/Wert: ${p.value || p.status || 'N/A'}\n`;
                        textOutput += `  Verantwortlicher: ${p.responsible || 'N/A'}\n`;
                        textOutput += `  Ma√ünahme: ${p.action || 'Keine'}\n`;
                        textOutput += `  ---------------------------------------------------\n`;
                    });
                    textOutput += `\n`;
                }
            }
            
            document.getElementById('textProtocolOutput').value = textOutput;
            alert('Textprotokoll generiert! Sie k√∂nnen es jetzt kopieren.');
        }

    </script>
</body>
</html>
